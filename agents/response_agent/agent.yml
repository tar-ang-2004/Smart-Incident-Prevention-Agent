agent:
  metadata:
    name: response_planning_agent
    version: 1.0.0
    type: response_orchestration
    orchestration_platform: ibm_watsonx_orchestrate
    created: 2026-01-30
    upstream_agent: analysis_agent
    downstream_agents:
      - ticketing_agent
      - action_execution_agent
    
  description: |
    Converts diagnostic intelligence from the Analysis Agent into structured, prioritized 
    response plans and escalation decisions. Determines appropriate response strategy, 
    selects relevant playbooks, evaluates human-in-the-loop requirements, and prepares 
    execution context for downstream ticketing and action agents. Acts as the bridge 
    between diagnosis and remediation.
    
  purpose: |
    Serve as the decision-making layer for incident response planning in a proactive 
    incident prevention system. Receive diagnostic reports with root cause hypotheses 
    and impact assessments, apply response strategy logic, map to appropriate playbooks,
    assess automation safety, determine escalation paths, and forward structured response 
    plans to ticketing and execution systems.
    
  scope: |
    WHAT THIS AGENT DOES:
    - Response strategy determination (immediate/urgent/planned/monitor)
    - Response playbook selection and ranking
    - Human-in-the-loop decision making
    - Escalation and notification planning
    - Ticketing and execution payload preparation
    - Safety and risk control assessment
    
    WHAT THIS AGENT DOES NOT DO:
    - Execute remediation actions (handled by action_execution_agent)
    - Create tickets (handled by ticketing_agent)
    - Send notifications (handled by orchestrator or notification service)
    - Perform diagnosis (handled by analysis_agent)
    - Detect incidents (handled by monitoring_agent)
    - Restart services, change configurations, or modify systems
    
  capabilities:
    - Multi-factor response strategy selection
    - Playbook mapping from root cause categories
    - Risk-based automation safety assessment
    - Escalation path determination
    - Priority and urgency classification
    - Human approval gate definition
    - Structured response plan generation
    - Safety constraint enforcement
    
  input_schema:
    type: object
    description: Diagnostic report from analysis_agent
    required:
      - diagnosis_id
      - escalation_id
      - source_system
      - root_cause_hypotheses
      - refined_severity
      - impact_assessment
      - diagnostic_confidence
      - response_planning_priority
    properties:
      diagnosis_id:
        type: string
        format: uuid
        description: Unique identifier for diagnostic analysis
      escalation_id:
        type: string
        format: uuid
        description: Reference to original monitoring escalation
      timestamp:
        type: string
        format: iso8601
        description: Diagnostic completion timestamp
      source_system:
        type: string
        description: System under analysis
      environment:
        type: string
        enum: [production, staging, development]
      root_cause_hypotheses:
        type: array
        minItems: 1
        maxItems: 3
        description: Ranked list of probable root causes from analysis_agent
        items:
          type: object
          required:
            - hypothesis_id
            - rank
            - root_cause
            - category
            - confidence
            - reasoning
          properties:
            hypothesis_id:
              type: string
            rank:
              type: integer
              minimum: 1
              maximum: 3
            root_cause:
              type: string
            category:
              type: string
              enum:
                - resource_exhaustion
                - configuration_error
                - dependency_failure
                - capacity_limit
                - data_corruption
                - network_issue
                - software_bug
                - external_service_degradation
                - infrastructure_failure
            confidence:
              type: number
              minimum: 0.0
              maximum: 1.0
            evidence:
              type: array
              items:
                type: string
            reasoning:
              type: string
            affected_components:
              type: array
              items:
                type: string
      refined_severity:
        type: object
        required:
          - severity_level
          - justification
        properties:
          severity_level:
            type: string
            enum: [LOW, MEDIUM, HIGH, CRITICAL]
          change_from_monitoring:
            type: string
            enum: [confirmed, upgraded, downgraded]
          justification:
            type: string
      impact_assessment:
        type: object
        required:
          - impact_scope
          - impact_areas
          - blast_radius
          - urgency_level
        properties:
          impact_scope:
            type: string
            enum: [localized, partial, widespread, total]
          impact_areas:
            type: object
            properties:
              user_experience:
                type: object
                properties:
                  impact_level:
                    type: string
                    enum: [none, minor, moderate, severe, critical]
                  description:
                    type: string
                  affected_user_percentage:
                    type: number
              business_operations:
                type: object
                properties:
                  impact_level:
                    type: string
                    enum: [none, minor, moderate, severe, critical]
                  description:
                    type: string
                  revenue_at_risk:
                    type: boolean
              data_integrity:
                type: object
                properties:
                  impact_level:
                    type: string
                    enum: [none, minor, moderate, severe, critical]
                  description:
                    type: string
                  data_loss_risk:
                    type: boolean
              sla_compliance:
                type: object
                properties:
                  impact_level:
                    type: string
                    enum: [none, minor, moderate, severe, critical]
                  description:
                    type: string
                  sla_breach_imminent:
                    type: boolean
          blast_radius:
            type: object
            properties:
              description:
                type: string
              affected_services:
                type: array
                items:
                  type: string
              cascade_risk:
                type: string
                enum: [none, low, medium, high]
              downstream_dependencies:
                type: array
                items:
                  type: string
          urgency_level:
            type: string
            enum: [low, medium, high, critical]
          estimated_time_to_impact:
            type: string
      diagnostic_confidence:
        type: number
        minimum: 0.0
        maximum: 1.0
        description: Overall confidence in diagnostic analysis
      uncertainty_factors:
        type: array
        description: Sources of uncertainty in diagnosis
        items:
          type: string
      response_planning_priority:
        type: string
        enum: [low, normal, high, critical]
        description: Recommended priority from analysis_agent
      diagnostic_summary:
        type: string
        description: Executive summary from analysis_agent
        
  output_schema:
    type: object
    required:
      - response_plan_id
      - diagnosis_id
      - timestamp
      - source_system
      - response_strategy
      - selected_playbooks
      - human_in_loop_mode
      - escalation_decisions
      - execution_payload
      - safety_controls
      - response_summary
    properties:
      response_plan_id:
        type: string
        format: uuid
        description: Unique identifier for this response plan
      diagnosis_id:
        type: string
        format: uuid
        description: Reference to diagnostic analysis
      escalation_id:
        type: string
        format: uuid
        description: Reference to original monitoring escalation
      timestamp:
        type: string
        format: iso8601
        description: Response plan creation timestamp
      source_system:
        type: string
        description: System requiring response
      environment:
        type: string
        enum: [production, staging, development]
      response_strategy:
        type: object
        required:
          - strategy_type
          - justification
          - execution_timeline
        properties:
          strategy_type:
            type: string
            enum: [immediate_emergency, urgent_investigation, planned_remediation, monitoring_only]
            description: Overall response approach
          justification:
            type: string
            description: Detailed reasoning for strategy selection
          execution_timeline:
            type: string
            enum: [immediate, within_1_hour, within_4_hours, within_24_hours, scheduled]
          priority_level:
            type: string
            enum: [p0_critical, p1_high, p2_medium, p3_low]
      selected_playbooks:
        type: array
        minItems: 0
        maxItems: 3
        description: Ranked list of applicable response playbooks
        items:
          type: object
          required:
            - playbook_id
            - playbook_name
            - rank
            - applicability_score
            - selection_rationale
          properties:
            playbook_id:
              type: string
            playbook_name:
              type: string
            rank:
              type: integer
              minimum: 1
              maximum: 3
            applicability_score:
              type: number
              minimum: 0.0
              maximum: 1.0
              description: How well playbook matches this scenario
            selection_rationale:
              type: string
              description: Why this playbook is relevant
            root_cause_category:
              type: string
              description: Root cause category this playbook addresses
            automation_level:
              type: string
              enum: [fully_automated, semi_automated, manual]
            estimated_resolution_time:
              type: string
      human_in_loop_mode:
        type: object
        required:
          - mode
          - justification
        properties:
          mode:
            type: string
            enum: [fully_automated, semi_automated, human_led]
            description: Level of automation permitted
          justification:
            type: string
            description: Reasoning for automation level decision
          approval_required_from:
            type: array
            items:
              type: string
              enum: [on_call_engineer, sre_team, incident_commander, platform_team, security_team, business_owner]
          approval_urgency:
            type: string
            enum: [immediate, urgent, normal]
      escalation_decisions:
        type: object
        required:
          - escalation_required
          - escalation_targets
        properties:
          escalation_required:
            type: boolean
            description: Whether to escalate to human teams
          escalation_targets:
            type: array
            items:
              type: object
              properties:
                target:
                  type: string
                  enum: [on_call_engineer, sre_team, incident_commander, platform_team, security_team, business_stakeholders, vendor_support]
                urgency:
                  type: string
                  enum: [immediate, urgent, normal]
                notification_method:
                  type: string
                  enum: [page, email, slack, ticket]
                reason:
                  type: string
          escalation_message:
            type: string
            description: Summary message for escalation notification
      execution_payload:
        type: object
        description: Structured payload for downstream execution/ticketing agents
        required:
          - forward_to_ticketing
          - forward_to_execution
        properties:
          forward_to_ticketing:
            type: boolean
            description: Whether to create ticket
          ticketing_context:
            type: object
            properties:
              ticket_priority:
                type: string
                enum: [P0, P1, P2, P3, P4]
              ticket_title:
                type: string
              ticket_description:
                type: string
              affected_services:
                type: array
                items:
                  type: string
              root_cause_summary:
                type: string
              impact_summary:
                type: string
              recommended_playbooks:
                type: array
                items:
                  type: string
          forward_to_execution:
            type: boolean
            description: Whether to forward to automated execution
          execution_context:
            type: object
            properties:
              automation_permitted:
                type: boolean
              selected_playbook_ids:
                type: array
                items:
                  type: string
              execution_constraints:
                type: array
                items:
                  type: string
              rollback_plan_required:
                type: boolean
      safety_controls:
        type: object
        required:
          - safety_assessment
          - constraints
        properties:
          safety_assessment:
            type: string
            enum: [safe_for_automation, requires_human_approval, manual_only, high_risk]
            description: Overall safety classification
          constraints:
            type: array
            description: Safety constraints that must be respected
            items:
              type: string
          risk_factors:
            type: array
            description: Identified risk factors affecting response
            items:
              type: object
              properties:
                risk_type:
                  type: string
                  enum: [data_loss, cascade_amplification, diagnostic_uncertainty, production_impact, configuration_risk]
                severity:
                  type: string
                  enum: [low, medium, high, critical]
                mitigation:
                  type: string
          safety_justification:
            type: string
            description: Detailed reasoning for safety classification
      response_summary:
        type: string
        description: Executive summary of response plan
      metadata:
        type: object
        properties:
          planning_duration_ms:
            type: integer
          playbooks_evaluated:
            type: integer
          strategy_rules_applied:
            type: array
            items:
              type: string
              
  response_strategy_rules:
    immediate_emergency:
      triggers:
        - severity: CRITICAL
          urgency: critical
        - severity: HIGH
          AND: impact_scope: total
        - data_loss_imminent: true
        - revenue_impact: critical
        - sla_breach_severity: severe
      characteristics:
        - execution_timeline: immediate
        - priority_level: p0_critical
        - escalation_required: true
        - human_approval_may_be_waived: true (for fully safe automations)
        
    urgent_investigation:
      triggers:
        - severity: HIGH
          urgency: high
        - severity: MEDIUM
          AND: cascade_risk: high
        - diagnostic_confidence: low
          AND: severity: [MEDIUM, HIGH]
      characteristics:
        - execution_timeline: within_1_hour
        - priority_level: p1_high
        - escalation_required: true
        - human_approval_required: true (if diagnostic confidence < 0.7)
        
    planned_remediation:
      triggers:
        - severity: MEDIUM
          urgency: medium
        - severity: LOW
          AND: impact_scope: partial
        - diagnostic_confidence: high
          AND: severity: MEDIUM
      characteristics:
        - execution_timeline: within_4_hours to within_24_hours
        - priority_level: p2_medium
        - escalation_required: false (unless specified)
        - automation_permitted: true (if safe)
        
    monitoring_only:
      triggers:
        - severity: LOW
          urgency: low
        - diagnostic_confidence: very_low
          AND: impact: minimal
        - self_healing_detected: true
      characteristics:
        - execution_timeline: scheduled or none
        - priority_level: p3_low
        - escalation_required: false
        - create_ticket_for_tracking: true
        
  human_in_loop_rules:
    fully_automated:
      permitted_when:
        - diagnostic_confidence >= 0.85
        - severity <= MEDIUM
        - data_loss_risk: false
        - cascade_risk <= low
        - well_tested_playbook: true
        - rollback_available: true
        
    semi_automated:
      required_when:
        - diagnostic_confidence: 0.6 - 0.85
        - severity: MEDIUM or HIGH
        - cascade_risk: medium
        - production_environment: true
        
    human_led:
      required_when:
        - severity: CRITICAL
        - diagnostic_confidence < 0.6
        - data_loss_risk: true
        - cascade_risk: high
        - novel_scenario: true
        - configuration_change_required: true
        
  safety_constraints:
    prevent_automation:
      - diagnostic_confidence < 0.6
      - data_integrity_risk: high
      - cascade_risk: high
      - insufficient_rollback_plan: true
      - untested_playbook: true
      - conflicting_hypotheses: true
      
    require_human_approval:
      - production_environment: true
        AND: impact_scope: [partial, widespread, total]
      - severity: [HIGH, CRITICAL]
      - data_modification_required: true
      - service_restart_required: true
        AND: user_impact: [moderate, severe, critical]
        
    default_to_conservative:
      - when_in_doubt: require human approval
      - unknown_blast_radius: manual only
      - novel_failure_pattern: human-led
      
  constraints:
    - Must complete response planning within 5 seconds
    - Must select 0-3 playbooks (may be 0 if monitoring-only strategy)
    - Must provide explainable justification for all decisions
    - Must not prescribe specific remediation commands
    - Must not execute any actions
    - Must operate deterministically on identical inputs
    - Must respect safety constraints strictly
    - Must default to human-in-loop when uncertain
    - Must maintain complete audit trail
    
  orchestrator_contract:
    invocation_mode: synchronous
    timeout: 5000ms
    retry_policy:
      max_attempts: 2
      backoff: exponential
    input_validation: strict
    output_validation: strict
    upstream_agent: analysis_agent
    downstream_agents:
      - ticketing_agent (for ticket creation)
      - action_execution_agent (for automated remediation)
      
  error_handling:
    malformed_input:
      action: return_error
      error_code: INVALID_DIAGNOSTIC_INPUT
      escalate: true
    processing_timeout:
      action: return_conservative_plan
      error_code: PLANNING_TIMEOUT
      escalate: true
      default_to: human_led
    playbook_unavailable:
      action: proceed_without_playbook
      error_code: PLAYBOOK_NOT_FOUND
      escalate: false
      create_manual_investigation_plan: true
      
  observability:
    logging:
      level: INFO
      include_input_summary: true
      include_output_summary: true
      include_decision_trace: true
      include_safety_assessment_trace: true
    metrics:
      - response_plans_generated_total
      - response_plans_by_strategy
      - response_plans_by_automation_level
      - playbooks_selected_distribution
      - escalations_triggered_total
      - safety_override_count
      - planning_duration_seconds
    tracing:
      enabled: true
      sample_rate: 1.0
      include_playbook_selection_logic: true
      
  compliance:
    data_retention: 90_days
    pii_handling: no_pii_expected
    audit_trail: required
    explainability: required
    safety_documentation: required
