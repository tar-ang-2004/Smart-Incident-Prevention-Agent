agent:
  metadata:
    name: analysis_agent
    version: 1.0.0
    type: diagnostic_reasoning
    orchestration_platform: ibm_watsonx_orchestrate
    created: 2026-01-30
    upstream_agent: monitoring_agent
    downstream_agent: response_planning_agent
    
  description: |
    Performs root cause hypothesis generation, severity refinement, and impact assessment 
    for escalated potential incidents. Transforms raw risk signals from the Monitoring Agent 
    into actionable diagnostic intelligence, providing structured analysis to support 
    informed response planning and decision-making.
    
  purpose: |
    Serve as the diagnostic reasoning layer in a proactive incident prevention system.
    Receive escalated risk assessments, apply causal inference and pattern analysis,
    generate ranked root cause hypotheses, assess business and technical impact,
    refine severity classifications, and forward comprehensive diagnostic reports
    to the Response Planning Agent for remediation action planning.
    
  scope: |
    WHAT THIS AGENT DOES:
    - Root cause hypothesis generation (WHY is this happening)
    - Severity refinement based on diagnostic context
    - Business and technical impact assessment
    - Dependency and cascade analysis
    - Diagnostic confidence scoring
    - Structured diagnostic reporting
    
    WHAT THIS AGENT DOES NOT DO:
    - Initial signal detection (handled by monitoring_agent)
    - Remediation recommendation (handled by response_planning_agent)
    - Ticket creation (handled by ticketing_agent)
    - Action execution (handled by response_planning_agent)
    - Human notification (handled by orchestrator)
    
  capabilities:
    - Causal inference from correlated signals
    - Multi-hypothesis root cause analysis
    - Impact scope assessment (user, business, data, SLA)
    - Dependency graph traversal and cascade detection
    - Severity upgrade/downgrade with justification
    - Diagnostic confidence quantification
    - Pattern-based knowledge retrieval
    - Structured diagnostic report generation
    
  input_schema:
    type: object
    description: Escalation payload from monitoring_agent
    required:
      - escalation_id
      - monitoring_assessment
      - original_signals
    properties:
      escalation_id:
        type: string
        format: uuid
        description: Unique identifier for this escalation event
      escalation_timestamp:
        type: string
        format: iso8601
        description: Time when monitoring_agent escalated this incident
      escalation_priority:
        type: string
        enum: [normal, urgent]
        description: Escalation priority from monitoring_agent
      monitoring_assessment:
        type: object
        description: Monitoring agent's risk assessment output
        required:
          - assessment_id
          - timestamp
          - source_system
          - risk_level
          - confidence_score
          - findings
          - reasoning
        properties:
          assessment_id:
            type: string
            format: uuid
          timestamp:
            type: string
            format: iso8601
          source_system:
            type: string
            description: Identifier for the affected system
          environment:
            type: string
            enum: [production, staging, development]
          risk_level:
            type: string
            enum: [MEDIUM, HIGH]
            description: Only MEDIUM or HIGH reach this agent
          confidence_score:
            type: number
            minimum: 0.6
            maximum: 1.0
            description: Monitoring agent confidence (only >= 0.6 escalated)
          findings:
            type: array
            description: Detected anomalies from monitoring_agent
            items:
              type: object
              required:
                - finding_type
                - description
                - severity
              properties:
                finding_type:
                  type: string
                  enum:
                    - error_rate_spike
                    - repeated_failures
                    - threshold_breach
                    - abnormal_pattern
                    - resource_saturation
                    - latency_degradation
                description:
                  type: string
                severity:
                  type: string
                  enum: [low, medium, high]
                evidence:
                  type: object
                affected_component:
                  type: string
          reasoning:
            type: string
            description: Monitoring agent's detection reasoning
          metadata:
            type: object
      original_signals:
        type: object
        description: Raw signals analyzed by monitoring_agent
        required:
          - logs
          - alerts
          - metrics
        properties:
          logs:
            type: array
            items:
              type: object
              properties:
                timestamp:
                  type: string
                level:
                  type: string
                message:
                  type: string
                source:
                  type: string
                trace_id:
                  type: string
                error_code:
                  type: string
          alerts:
            type: array
            items:
              type: object
              properties:
                alert_id:
                  type: string
                severity:
                  type: string
                description:
                  type: string
                metric_name:
                  type: string
                threshold_value:
                  type: number
                current_value:
                  type: number
                duration:
                  type: string
          metrics:
            type: object
            properties:
              error_rate:
                type: number
              response_time_p95:
                type: number
              cpu_utilization:
                type: number
              memory_utilization:
                type: number
              request_rate:
                type: number
              queue_depth:
                type: integer
                
  output_schema:
    type: object
    required:
      - diagnosis_id
      - escalation_id
      - timestamp
      - source_system
      - root_cause_hypotheses
      - refined_severity
      - impact_assessment
      - diagnostic_confidence
      - forward_to_response_planning
      - diagnostic_summary
    properties:
      diagnosis_id:
        type: string
        format: uuid
        description: Unique identifier for this diagnostic analysis
      escalation_id:
        type: string
        format: uuid
        description: Reference to originating escalation
      timestamp:
        type: string
        format: iso8601
        description: Diagnostic analysis completion time
      source_system:
        type: string
        description: System under analysis
      environment:
        type: string
        enum: [production, staging, development]
      root_cause_hypotheses:
        type: array
        minItems: 1
        maxItems: 3
        description: Ranked list of probable root causes
        items:
          type: object
          required:
            - hypothesis_id
            - rank
            - root_cause
            - confidence
            - evidence
            - reasoning
          properties:
            hypothesis_id:
              type: string
              description: Unique identifier for this hypothesis
            rank:
              type: integer
              minimum: 1
              maximum: 3
              description: Rank by likelihood (1 = most likely)
            root_cause:
              type: string
              description: Concise root cause statement
            category:
              type: string
              enum:
                - resource_exhaustion
                - configuration_error
                - dependency_failure
                - capacity_limit
                - data_corruption
                - network_issue
                - software_bug
                - external_service_degradation
                - infrastructure_failure
            confidence:
              type: number
              minimum: 0.0
              maximum: 1.0
              description: Confidence in this hypothesis
            evidence:
              type: array
              description: Supporting evidence from signals
              items:
                type: string
            reasoning:
              type: string
              description: Detailed explanation of causal inference
            affected_components:
              type: array
              items:
                type: string
              description: Components implicated in this hypothesis
      refined_severity:
        type: object
        required:
          - severity_level
          - change_from_monitoring
          - justification
        properties:
          severity_level:
            type: string
            enum: [LOW, MEDIUM, HIGH, CRITICAL]
            description: Refined severity after diagnostic analysis
          change_from_monitoring:
            type: string
            enum: [confirmed, upgraded, downgraded]
            description: How severity changed from monitoring_agent assessment
          original_severity:
            type: string
            enum: [MEDIUM, HIGH]
          justification:
            type: string
            description: Detailed explanation for severity refinement
      impact_assessment:
        type: object
        required:
          - impact_scope
          - impact_areas
          - blast_radius
          - urgency_level
        properties:
          impact_scope:
            type: string
            enum: [localized, partial, widespread, total]
            description: Geographical or architectural scope of impact
          impact_areas:
            type: object
            required:
              - user_experience
              - business_operations
              - data_integrity
              - sla_compliance
            properties:
              user_experience:
                type: object
                properties:
                  impact_level:
                    type: string
                    enum: [none, minor, moderate, severe, critical]
                  description:
                    type: string
                  affected_user_percentage:
                    type: number
                    minimum: 0
                    maximum: 100
              business_operations:
                type: object
                properties:
                  impact_level:
                    type: string
                    enum: [none, minor, moderate, severe, critical]
                  description:
                    type: string
                  revenue_at_risk:
                    type: boolean
              data_integrity:
                type: object
                properties:
                  impact_level:
                    type: string
                    enum: [none, minor, moderate, severe, critical]
                  description:
                    type: string
                  data_loss_risk:
                    type: boolean
              sla_compliance:
                type: object
                properties:
                  impact_level:
                    type: string
                    enum: [none, minor, moderate, severe, critical]
                  description:
                    type: string
                  sla_breach_imminent:
                    type: boolean
          blast_radius:
            type: object
            properties:
              description:
                type: string
              affected_services:
                type: array
                items:
                  type: string
              cascade_risk:
                type: string
                enum: [none, low, medium, high]
              downstream_dependencies:
                type: array
                items:
                  type: string
          urgency_level:
            type: string
            enum: [low, medium, high, critical]
            description: Time sensitivity for response
          estimated_time_to_impact:
            type: string
            description: Estimated time before user-visible impact (if not already impacted)
      diagnostic_confidence:
        type: number
        minimum: 0.0
        maximum: 1.0
        description: Overall confidence in diagnostic analysis
      uncertainty_factors:
        type: array
        description: Sources of uncertainty in diagnosis
        items:
          type: string
      forward_to_response_planning:
        type: boolean
        description: Whether to forward to response_planning_agent
      response_planning_priority:
        type: string
        enum: [low, normal, high, critical]
        description: Recommended priority for response planning
      diagnostic_summary:
        type: string
        description: Executive summary of diagnostic findings
      metadata:
        type: object
        properties:
          analysis_duration_ms:
            type: integer
          hypotheses_evaluated:
            type: integer
          knowledge_base_queries:
            type: integer
          correlation_patterns_matched:
            type: array
            items:
              type: string
              
  severity_refinement_rules:
    upgrade_to_critical:
      conditions:
        - multiple_critical_systems_affected: true
          justification: Cascading failure across critical business services
        - data_loss_imminent: true
          justification: Risk of permanent data loss or corruption
        - sla_breach_certain: true
          AND: revenue_impact_significant: true
          justification: Contractual SLA violation with financial impact
        - complete_service_outage: true
          justification: Total service unavailability
          
    upgrade_to_high:
      conditions:
        - impact_scope: widespread
          AND: user_experience_impact: severe
          justification: Wide-reaching severe user impact
        - cascade_risk: high
          justification: High probability of cascading failures
        - root_cause_confidence: high
          AND: remediation_time_sensitive: true
          justification: Clear diagnosis requiring immediate action
          
    downgrade_to_medium:
      conditions:
        - impact_scope: localized
          AND: workaround_available: true
          justification: Limited scope with mitigation options
        - false_positive_indicators: present
          justification: Signals suggest less severe than initially assessed
        - self_healing_detected: true
          justification: System showing recovery behavior
          
    downgrade_to_low:
      conditions:
        - root_cause_confidence: low
          AND: impact_assessment: minimal
          justification: Insufficient evidence for higher severity
        - signals_inconsistent: true
          justification: Conflicting signals suggest lower severity
          
  diagnostic_methodology:
    hypothesis_generation:
      approach: evidence_based_inference
      max_hypotheses: 3
      ranking_criteria:
        - evidence_strength
        - pattern_match_quality
        - historical_precedent
        - causal_logic_soundness
      confidence_thresholds:
        high: 0.8
        medium: 0.6
        low: 0.4
        
    impact_assessment_framework:
      user_experience:
        critical: complete_service_unavailability OR data_loss
        severe: major_functionality_broken OR performance_degradation_severe
        moderate: partial_functionality_impaired OR latency_noticeable
        minor: minor_inconvenience OR edge_case_failure
        none: no_user_facing_impact
        
      business_operations:
        critical: revenue_generating_process_stopped OR compliance_violation
        severe: key_business_process_degraded OR partner_impact
        moderate: operational_efficiency_reduced OR reporting_delayed
        minor: minor_workflow_disruption OR non_critical_delay
        none: no_business_impact
        
    cascade_detection:
      patterns:
        - connection_pool_exhaustion → downstream_timeouts
        - database_saturation → application_layer_failures
        - memory_pressure → garbage_collection_storms → request_queuing
        - network_congestion → retry_storms → amplification
        - circuit_breaker_open → cascading_circuit_breaks
        
  constraints:
    - Must complete diagnostic analysis within 10 seconds
    - Must generate 1-3 root cause hypotheses (never 0, never more than 3)
    - Must provide explainable reasoning for all hypotheses
    - Must clearly distinguish hypotheses from confirmed facts
    - Must not recommend specific remediation actions
    - Must not execute any operational commands
    - Must not invent or hallucinate system states
    - Must operate deterministically on identical inputs
    - Must maintain complete audit trail
    - Must forward all MEDIUM+ severity diagnoses to response_planning_agent
    - Must avoid diagnostic overconfidence
    - Must acknowledge uncertainty when present
    
  orchestrator_contract:
    invocation_mode: synchronous
    timeout: 10000ms
    retry_policy:
      max_attempts: 2
      backoff: exponential
    input_validation: strict
    output_validation: strict
    upstream_agent: monitoring_agent
    downstream_agent: response_planning_agent
    
  error_handling:
    malformed_input:
      action: return_error
      error_code: INVALID_ESCALATION_PAYLOAD
      escalate: true
    processing_timeout:
      action: return_partial_diagnosis
      error_code: DIAGNOSTIC_TIMEOUT
      escalate: true
    insufficient_evidence:
      action: return_low_confidence_diagnosis
      error_code: INSUFFICIENT_DIAGNOSTIC_EVIDENCE
      escalate: true
      include_uncertainty_note: true
    knowledge_base_unavailable:
      action: proceed_with_signal_analysis_only
      error_code: KB_UNAVAILABLE
      escalate: false
      
  observability:
    logging:
      level: INFO
      include_input_summary: true
      include_output_summary: true
      include_hypothesis_generation_trace: true
      include_severity_refinement_trace: true
    metrics:
      - diagnoses_completed_total
      - diagnoses_by_refined_severity
      - hypotheses_generated_distribution
      - diagnostic_confidence_distribution
      - severity_upgrades_total
      - severity_downgrades_total
      - processing_duration_seconds
      - forwards_to_response_planning_total
    tracing:
      enabled: true
      sample_rate: 1.0
      include_knowledge_base_queries: true
      
  knowledge_base_integration:
    enabled: true
    query_timeout: 2000ms
    pattern_matching:
      - error_code_patterns
      - symptom_cause_mappings
      - historical_incident_correlation
      - dependency_graph_traversal
    fallback_behavior: continue_without_kb
    
  compliance:
    data_retention: 90_days
    pii_handling: no_pii_expected
    audit_trail: required
    explainability: required
    hypothesis_labeling: required
